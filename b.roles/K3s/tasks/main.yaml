---
### ### ### Vars ### ### ###
- name: Include all .json and .jsn files in vars/all and all nested directories (2.3)
  ansible.builtin.include_vars:
    dir: vars/

### ### ### K3s Cluster ### ### ###
- name: K3s Cluster
  block:
    - name: Download and install k3s
      shell: "curl -sfL https://get.k3s.io | sh -s - server {{ ' '.join(k3s_options) }}"
      register: k3s_install_output

    - name: Log k3s installation output
      debug:
        msg: "{{ k3s_install_output.stdout }}"
  when: deploy_type == "k3s"

### ### ### K3s Applications ### ### ###
- name: K3s Applications
  block:
    - name: Add Helm repository for
      kubernetes.core.helm_repository:
        name: "{{ item.namespace }}"
        repo_url: "{{ item.repo_url }}"
      loop: "{{ applications[app].items() }}"
            
    - name: Deploy Helm chart for
      kubernetes.core.helm:
        name: "{{ item.release_name | default(item.chart_ref.split('/')[-1]) }}"
        chart_ref: "{{ item.chart_ref }}"
        release_namespace: "{{ item.namespace }}"
        create_namespace: true
        values: "{{ lookup('template', '../vars/{{ helm }}.yaml') | from_yaml }}"
      loop: "{{ applications[app].items() }}"
  when: deploy_type == "app" and item.name == 
  
  
  
